<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Magic Sets - DeckDen</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    *{box-sizing:border-box}
    :root{
      --bg:#ffffff; --text:#222222; --accent:#cc5200;
      --divider:#000000; --muted:#666; --hover:rgba(0,0,0,.04);
    }
    .dark-mode{
      --bg:#121212; --text:#f1f1f1; --accent:#cc5200;
      --divider:#ffffff; --muted:#aaa; --hover:rgba(255,255,255,.06);
    }
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;transition:.25s ease;overflow-x:hidden}

    /* Header */
    nav{width:100%;background:var(--accent);display:flex;justify-content:space-between;align-items:center;padding:8px 20px;position:sticky;top:0;z-index:100}
    .nav-left{display:flex;align-items:center}
    .nav-left img{width:36px;height:36px;margin-right:12px;cursor:pointer}
    .nav-links{display:flex;gap:12px}
    .nav-links a{color:#fff;text-decoration:none;font-weight:700;font-size:.95rem;opacity:.95}
    .nav-links a:hover{opacity:1}
    .nav-right{display:flex;align-items:center}
    .nav-right input{width:220px;max-width:45vw;padding:6px 10px;border-radius:6px;border:none;margin-right:12px}
    .nav-right button{margin-left:8px;padding:6px 10px;border:none;border-radius:8px;background:#fff;color:var(--accent);cursor:pointer;font-size:.85rem}
    .nav-right i{color:#fff;font-size:1.2rem;margin-left:12px;cursor:pointer}
    .menu-toggle{display:none;font-size:1.5rem;color:#fff;margin-left:15px;cursor:pointer}
    .mobile-menu{display:none;flex-direction:column;background:var(--accent);padding:10px 20px}
    .mobile-menu a,.mobile-menu input{margin:8px 0}

    /* Page */
    .content{max-width:1000px;margin:0 auto;padding:28px 16px}
    h1{margin:0 0 8px;text-align:center;color:var(--accent)}
    .subtitle{margin:0 0 14px;text-align:center;color:var(--muted);font-size:.95rem}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:6px 0 18px}
    .toolbar input[type="text"]{min-width:260px;max-width:90vw;padding:8px 10px;border:1px solid var(--divider);border-radius:8px;background:transparent;color:var(--text)}

    /* Text-only set list with 1px divider */
    .sets{border-top:1px solid var(--divider)}
    .row{
      display:flex;align-items:center;gap:10px;
      border-bottom:1px solid var(--divider);
      padding:10px 8px; transition:background .15s ease;
    }
    .row:hover{background:var(--hover)}
    .name{flex:1 1 auto;display:flex;align-items:center;gap:10px}
    .name a{color:var(--text);text-decoration:none}
    .name a:hover{text-decoration:underline}
    .meta{font-size:.85rem;color:var(--muted)}
    .badge{font-size:.72rem;padding:2px 6px;border:1px solid var(--divider);border-radius:6px;color:var(--muted)}

    /* Hierarchy */
    .parent .title{font-weight:800;font-size:1.05rem;letter-spacing:.2px}
    .subset{padding-left:24px}
    .subset .title{font-weight:600;font-size:.95rem}

    @media (max-width:768px){
      .nav-links,.nav-right input{display:none}
      .menu-toggle{display:block}
      .mobile-menu.show{display:flex}
      .row{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <nav>
    <div class="nav-left">
      <a href="index.html" title="Home"><img src="Deckden Transparent.png" alt="Home"></a>
      <div class="nav-links">
        <a href="magic-sets.html">Magic Sets</a>
        <a href="#">Cart</a>
        <a href="#">About Us</a>
      </div>
    </div>
    <div class="nav-right">
      <input id="searchTop" type="text" placeholder="Search sets...">
      <i class="fas fa-user" title="Account"></i>
      <button onclick="toggleDarkMode()" title="Toggle dark mode">ðŸŒ™</button>
      <i class="fas fa-bars menu-toggle" onclick="toggleMenu()" title="Menu"></i>
    </div>
  </nav>

  <div class="mobile-menu" id="mobileMenu">
    <a href="magic-sets.html">Magic Sets</a>
    <a href="#">Cart</a>
    <a href="#">About Us</a>
    <input id="searchMobile" type="text" placeholder="Search sets...">
  </div>

  <div class="content">
    <h1>Magic Sets</h1>
    <p class="subtitle">Text-only list. Main sets are bold; subsets appear indented. Visibility is controlled from your Google Sheet.</p>

    <div class="toolbar">
      <input id="search" type="text" placeholder="Filter by name or codeâ€¦">
    </div>

    <div id="setsList" class="sets" aria-live="polite">Loading setsâ€¦</div>
  </div>

  <script>
    /* --------- Config: put your Web App URL here --------- */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwQplXlimKPYZ_VjIh0qhpKrFYlVl2_GdlzXFjJyF_YH4VuWvtci_2Oo73jJhtZvTRe/exec?onlyVisible=1"; // e.g. https://script.google.com/macros/s/XXXX/exec

    /* --------- Header actions --------- */
    function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
    function toggleMenu(){ document.getElementById('mobileMenu').classList.toggle('show'); }

    /* --------- State --------- */
    const state = {
      groups: [],   // [{parent, subsets:[]}]
      query: ""
    };

    /* --------- Load sets from your Sheet Web App (only visible rows) --------- */
    async function loadSets(){
      try{
        if(!WEB_APP_URL || WEB_APP_URL.includes("YOUR_WEB_APP_URL_HERE")){
          document.getElementById('setsList').innerHTML =
            '<div class="row"><div class="name"><span class="title">Please set WEB_APP_URL in magic-sets.html</span></div></div>';
          return;
        }
        const res = await fetch(`${WEB_APP_URL}?onlyVisible=1`, {cache:"no-store"});
        const payload = await res.json();
        const sets = (payload && payload.sets) ? payload.sets : [];

        // Build groups by parent_set_code (parent prominent, subsets indented)
        const byCode = new Map(sets.map(s => [String(s.code).toLowerCase(), s]));
        const groupsMap = new Map();

        sets.forEach(s=>{
          const code = String(s.code||"").toLowerCase();
          const parentCode = String(s.parent_set_code||"").toLowerCase();
          if(parentCode && byCode.has(parentCode)){
            if(!groupsMap.has(parentCode)) groupsMap.set(parentCode, { parent: byCode.get(parentCode), subsets: [] });
            // avoid duplicating the parent inside its own subsets
            if(code !== parentCode) groupsMap.get(parentCode).subsets.push(s);
          } else {
            // a standalone parent (or parent not present in visible list)
            if(!groupsMap.has(code)) groupsMap.set(code, { parent: s, subsets: [] });
          }
        });

        // Sort: newest parents first by released_at; subsets newest-first too
        const safeDate = d => (d ? String(d) : "");
        const groups = Array.from(groupsMap.values());
        groups.sort((a,b)=> safeDate(b.parent.released_at).localeCompare(safeDate(a.parent.released_at)));
        groups.forEach(g => g.subsets.sort((a,b)=> safeDate(b.released_at).localeCompare(safeDate(a.released_at))));

        state.groups = groups;
        render();
      }catch(err){
        document.getElementById('setsList').innerHTML =
          `<div class="row"><div class="name"><span class="title">Error loading sets: ${String(err.message || err)}</span></div></div>`;
      }
    }

    /* --------- Render text-only list with 1px divider --------- */
    function render(){
      const list = document.getElementById('setsList');
      list.innerHTML = "";

      const q = state.query.trim().toLowerCase();

      state.groups.forEach(group=>{
        const parent = group.parent;
        const parentMatches = !q || parent.name.toLowerCase().includes(q) || String(parent.code).toLowerCase().includes(q);

        // Filter subsets by query
        const filteredSubsets = group.subsets.filter(s => {
          if(!q) return true;
          const n = s.name.toLowerCase();
          const c = String(s.code).toLowerCase();
          return n.includes(q) || c.includes(q);
        });

        // If nothing matches, skip whole group
        if(!parentMatches && filteredSubsets.length === 0) return;

        // Parent row
        const prow = document.createElement('div');
        prow.className = 'row parent';
        const pName = document.createElement('div');
        pName.className = 'name';

        const pLink = document.createElement('a');
        pLink.href = `set.html?code=${parent.code}&name=${encodeURIComponent(parent.name)}`;
        pLink.className = 'title';
        pLink.textContent = parent.name;

        const pMeta = document.createElement('span');
        pMeta.className = 'meta';
        pMeta.textContent = `(${String(parent.code).toUpperCase()} â€¢ ${String(parent.set_type || "").replaceAll('_',' ')})`;

        const pBadge = document.createElement('span');
        pBadge.className = 'badge';
        pBadge.textContent = filteredSubsets.length ? `${filteredSubsets.length} subset${filteredSubsets.length>1?'s':''}` : 'no subsets';

        pName.append(pLink, pMeta, pBadge);
        prow.appendChild(pName);
        list.appendChild(prow);

        // Subsets
        filteredSubsets.forEach(sub=>{
          const srow = document.createElement('div');
          srow.className = 'row subset';
          const sName = document.createElement('div');
          sName.className = 'name';
          const sLink = document.createElement('a');
          sLink.href = `set.html?code=${sub.code}&name=${encodeURIComponent(sub.name)}`;
          sLink.className = 'title';
          sLink.textContent = sub.name;

          const sMeta = document.createElement('span');
          sMeta.className = 'meta';
          sMeta.textContent = `(${String(sub.code).toUpperCase()} â€¢ ${String(sub.set_type || "").replaceAll('_',' ')})`;

          sName.append(sLink, sMeta);
          srow.appendChild(sName);
          list.appendChild(srow);
        });
      });

      // Empty state
      if(!list.children.length){
        list.innerHTML = `<div class="row"><div class="name"><span class="title">No sets match your search.</span></div></div>`;
      }
    }

    /* --------- Search wiring (top + mobile + toolbar) --------- */
    function wireSearch(){
      const inputs = [
        document.getElementById('searchTop'),
        document.getElementById('searchMobile'),
        document.getElementById('search')
      ].filter(Boolean);

      const onInput = (e)=>{ state.query = e.target.value || ""; render(); };
      inputs.forEach(inp => inp && inp.addEventListener('input', onInput));
    }

    // Init
    wireSearch();
    loadSets();
  </script>
</body>
</html>


