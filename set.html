<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set â€“ DeckDen</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --bg:#ffffff; --text:#222; --muted:#666;
      --accent:#b84e00; /* darker orange */
      --card:#fff; --line:#e8e8e8; --line-strong:#000;
      --chip:#f5f5f5;
    }
    .dark-mode{
      --bg:#121212; --text:#f1f1f1; --muted:#c7c7c7;
      --accent:#b84e00;
      --card:#1b1b1b; --line:#2a2a2a; --line-strong:#fff;
      --chip:#1f1f1f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif;transition:background .25s,color .25s}
    a{color:inherit;text-decoration:none}

    /* Header */
    nav{
      width:100%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:space-between;
      padding:8px 16px;position:sticky;top:0;z-index:10
    }
    .nav-left{display:flex;align-items:center;gap:10px}
    .nav-left img{width:34px;height:34px;object-fit:contain;cursor:pointer}
    .nav-links{display:flex;gap:12px}
    .nav-links a{color:#fff;font-weight:600;opacity:.95}
    .nav-links a:hover{opacity:1}
    .nav-right{display:flex;align-items:center;gap:10px}
    .nav-right input[type="search"]{display:none}
    .nav-right .icon-btn{background:#fff;border:none;color:var(--accent);padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600}
    .nav-right i{font-size:1.1rem;cursor:pointer}

    .container{max-width:1100px;margin:24px auto;padding:0 16px}

    /* Controls row */
    .controls{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:8px 10px;display:flex;align-items:center;gap:8px
    }
    .chip label{font-size:.85rem;color:var(--muted)}
    .chip input[type="search"]{border:none;background:transparent;outline:none;color:var(--text);min-width:260px}
    .chip select{border:none;background:transparent;outline:none;color:var(--text)}
    .chip input[type="checkbox"]{transform:translateY(1px)}
    .clear-btn{margin-left:auto;background:transparent;border:1px dashed var(--line);color:var(--muted);border-radius:10px;padding:8px 10px;cursor:pointer}
    .clear-btn:hover{border-color:var(--muted);color:var(--text)}
    .divider{height:1px;background:var(--line-strong);margin:8px 0}

    /* Table */
    .table-wrap{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    thead{background:linear-gradient(to bottom, rgba(0,0,0,.06), rgba(0,0,0,0))}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{font-size:.85rem;color:var(--muted);user-select:none;cursor:pointer;white-space:nowrap}
    th .sort{margin-left:6px;opacity:.6}
    tr:hover td{background:rgba(0,0,0,.02)}
    .name-cell{font-weight:600}
    .no-results{padding:24px;text-align:center;color:var(--muted)}

    /* Mana icons */
    .mana{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;border:1px solid var(--line);font-size:.75rem;font-weight:700;margin-right:4px}
    .mana.W{background:#fff;color:#111}
    .mana.U{background:#4aa3ff;color:#fff}
    .mana.B{background:#111;color:#fff}
    .mana.R{background:#e23a2e;color:#fff}
    .mana.G{background:#2e8b57;color:#fff}
    .mana.C{background:#aaa;color:#fff}
    .mana-wrap{display:flex;align-items:center;gap:2px}

    /* Buttons */
    .btn{
      background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:10px;cursor:pointer;white-space:nowrap
    }
    .btn:hover{border-color:var(--muted)}
    .btn.cart{display:inline-flex;align-items:center;gap:6px}

    /* Pagination footer */
    .pager{
      display:flex;align-items:center;gap:12px;justify-content:space-between;margin-top:12px;flex-wrap:wrap
    }
    .pager .left, .pager .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pager .btn[disabled]{opacity:.5;cursor:not-allowed}
    .pager .info{color:var(--muted);font-size:.9rem}
    .pager select{border:1px solid var(--line);background:var(--chip);padding:6px 8px;border-radius:8px;color:var(--text)}

    /* Responsive */
    @media (max-width: 900px){
      .nav-links{display:none}
      th:nth-child(6), td:nth-child(6){display:none} /* Type on narrow */
      th:nth-child(8), td:nth-child(8){display:none} /* Variant on narrow */
    }
    @media (max-width: 640px){
      th:nth-child(5), td:nth-child(5){display:none} /* Colour on very narrow */
      .controls .row .chip label{display:none}
      .nav-right input[type="search"]{display:block;width:150px;padding:6px 8px;border-radius:8px;border:none}
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-left">
      <a href="index.html" title="Home">
        <img src="Deckden Transparent.png" alt="DeckDen logo">
      </a>
      <div class="nav-links">
        <a href="magic-sets.html">Magic Sets</a>
        <a href="#">Cart</a>
        <a href="#">About Us</a>
      </div>
    </div>
    <div class="nav-right">
      <input id="qsHeader" type="search" placeholder="Searchâ€¦"/>
      <i class="fas fa-user" title="Account"></i>
      <button class="icon-btn" onclick="toggleDarkMode()" title="Dark mode">ðŸŒ™</button>
    </div>
  </nav>

  <div class="container">
    <h1 id="setTitle">Loadingâ€¦</h1>

    <!-- Controls -->
    <div class="controls">
      <div class="row">
        <div class="chip">
          <label for="q">Search</label>
          <input id="q" type="search" placeholder="Search cardsâ€¦ (name/type/variant)"/>
        </div>
        <div class="chip">
          <label for="typeFilter">Type</label>
          <select id="typeFilter"><option value="">All Types</option></select>
        </div>
        <div class="chip">
          <label for="finishFilter">Finish</label>
          <select id="finishFilter"><option value="">All Finishes</option></select>
        </div>
        <div class="chip">
          <label for="rarityFilter">Rarity</label>
          <select id="rarityFilter"><option value="">All Rarities</option></select>
        </div>
        <div class="chip">
          <label for="variantFilter">Variant</label>
          <select id="variantFilter"><option value="">All Variants</option></select>
        </div>
        <div class="chip">
          <input id="inStock" type="checkbox"/>
          <label for="inStock">In stock only</label>
        </div>
        <button class="clear-btn" id="clearFilters">Clear</button>
      </div>
      <div class="divider"></div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table id="cardsTable" aria-describedby="setTitle">
        <thead>
          <tr>
            <th data-key="price">Price (AUD) <span class="sort">â†•</span></th>
            <th data-key="name">Name <span class="sort">â†•</span></th>
            <th data-key="number"># <span class="sort">â†•</span></th>
            <th data-key="finish">Finish <span class="sort">â†•</span></th>
            <th>Colour</th>
            <th data-key="type">Type <span class="sort">â†•</span></th>
            <th data-key="rarity">Rarity <span class="sort">â†•</span></th>
            <th data-key="variant">Variant <span class="sort">â†•</span></th>
            <th data-key="stock">Stock <span class="sort">â†•</span></th>
            <th><!-- Cart --></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="10" class="no-results">Loading cardsâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination footer -->
    <div class="pager">
      <div class="left">
        <button id="prevBtn" class="btn">Prev</button>
        <button id="nextBtn" class="btn">Next</button>
        <span class="info" id="pageInfo">Page 1 of 1</span>
      </div>
      <div class="right">
        <label class="info" for="pageSize">Rows per page</label>
        <select id="pageSize">
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  </div>

  <script>
    /* -----------------------------
       CONFIG: your Web App
       ----------------------------- */
    const CARDS_API_BASE = "https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYMENT_ID/exec";

    /* -----------------------------
       THEME
       ----------------------------- */
    function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }
    document.getElementById('qsHeader').addEventListener('input', (e)=>{
      document.getElementById('q').value = e.target.value;
      state.filters.q = e.target.value;
      resetToFirstPageAndRender();
    });

    /* -----------------------------
       STATE
       ----------------------------- */
    const state = {
      setCode: null,
      setName: null,
      raw: [],
      view: [],
      sort: { key: 'price', dir: 'asc' }, // start by price since it's first
      filters: { q:'', type:'', finish:'', rarity:'', variant:'', inStock:false },
      page: 1,
      pageSize: 20
    };

    /* -----------------------------
       UTILITIES
       ----------------------------- */
    function parseColourId(ci){
      const parts = String(ci||"").split(',').filter(Boolean);
      return parts.length ? parts : ["C"];
    }
    function manaIcon(letter){
      const L = (letter||"C").toUpperCase();
      return `<span class="mana ${L}" title="${L}">${L}</span>`;
    }
    function manaIcons(ci){
      const arr = parseColourId(ci);
      return `<span class="mana-wrap">${arr.map(manaIcon).join("")}</span>`;
    }
    function typeBucket(typeLine){
      if(!typeLine) return "";
      const t = String(typeLine).toLowerCase();
      const order = ["creature","instant","sorcery","artifact","enchantment","planeswalker","battle","land"];
      for(const k of order){ if(t.includes(k)) return k.charAt(0).toUpperCase()+k.slice(1); }
      return typeLine.split('â€”')[0].trim();
    }
    function normalizeRow(row){
      const name = row["Card Name"] || row.name || "";
      const number = String(row["Collector No"] || row["Collector Number"] || row.number || "").trim();
      const price = parseFloat(row["Sell Price (AUD, +10%)"] || row["Market AUD"] || row.price || "0") || 0;
      const colourId = row["Color Identity"] || row["Colour Identity"] || row.colour || "";
      const type = typeBucket(row["Type Line"] || row.type || "");
      const rarity = (row["Rarity"] || row.rarity || "").toString().toLowerCase();
      const finish = (row["Finish"] || row.finish || "").toString().toLowerCase();
      const variant = row["Variant"] || row.variant || "Standard";
      const stock = parseInt(row["Qty Owned"] || row["Quantity Owned"] || row.stock || "0", 10) || 0;
      return { name, number, price, colourId, type, rarity, finish, variant, stock, _raw: row };
    }
    function uniqueSorted(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }
    function formatPrice(n){ return n>0 ? `$${n.toFixed(2)}` : ""; }

    /* -----------------------------
       RENDER
       ----------------------------- */
    function renderFiltersFromData(fullRows){
      const typeSel = document.getElementById('typeFilter');
      const finishSel = document.getElementById('finishFilter');
      const raritySel = document.getElementById('rarityFilter');
      const variantSel = document.getElementById('variantFilter');

      const types = uniqueSorted(fullRows.map(r=>r.type));
      const finishes = uniqueSorted(fullRows.map(r=>r.finish));
      const rarities = uniqueSorted(fullRows.map(r=>r.rarity));
      const variants = uniqueSorted(fullRows.map(r=>r.variant));

      function fillSelect(sel, items, label){
        const keep = sel.value;
        sel.innerHTML = `<option value="">All ${label}</option>` + items.map(v=>`<option value="${v}">${v}</option>`).join('');
        if(items.includes(keep)) sel.value = keep;
      }
      fillSelect(typeSel, types, "Types");
      fillSelect(finishSel, finishes.map(f=>f.charAt(0).toUpperCase()+f.slice(1)), "Finishes");
      fillSelect(raritySel, rarities.map(r=>r.charAt(0).toUpperCase()+r.slice(1)), "Rarities");
      fillSelect(variantSel, variants, "Variants");
    }

    function renderTable(){
      const tb = document.getElementById('tbody');
      if(state.view.length===0){
        tb.innerHTML = `<tr><td colspan="10" class="no-results">No cards match your filters.</td></tr>`;
        updatePager();
        return;
      }

      const start = (state.page - 1) * state.pageSize;
      const end = start + state.pageSize;
      const pageRows = state.view.slice(start, end);

      const rowsHtml = pageRows.map(r => `
        <tr>
          <td>${formatPrice(r.price)}</td>
          <td class="name-cell"><a href="card.html?code=${encodeURIComponent(state.setCode)}&number=${encodeURIComponent(r.number)}&name=${encodeURIComponent(r.name)}&finish=${encodeURIComponent(r.finish)}&variant=${encodeURIComponent(r.variant)}">${r.name}</a></td>
          <td>${r.number || ''}</td>
          <td>${r.finish ? r.finish.charAt(0).toUpperCase()+r.finish.slice(1) : ''}</td>
          <td>${manaIcons(r.colourId)}</td>
          <td>${r.type}</td>
          <td>${r.rarity ? r.rarity.charAt(0).toUpperCase()+r.rarity.slice(1) : ''}</td>
          <td>${r.variant}</td>
          <td>${r.stock}</td>
          <td><button class="btn cart" onclick='addToCart(${JSON.stringify({n:""+r.name,no:""+r.number,f:""+r.finish,v:""+r.variant}).replace(/"/g,"&quot;")})'><i class="fa-solid fa-cart-plus"></i> Add</button></td>
        </tr>
      `).join('');
      tb.innerHTML = rowsHtml;

      updatePager();
    }

    function updatePager(){
      const total = state.view.length;
      const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
      if(state.page > totalPages) state.page = totalPages;
      document.getElementById('pageInfo').textContent = `Page ${totalPages ? state.page : 1} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = (state.page <= 1);
      document.getElementById('nextBtn').disabled = (state.page >= totalPages);
    }

    /* -----------------------------
       FILTER + SORT + PAGINATION
       ----------------------------- */
    function applyFiltersAndSort(){
      const f = state.filters;
      const q = f.q.trim().toLowerCase();

      let v = state.raw.filter(r => {
        if(f.inStock && !(r.stock>0)) return false;
        if(f.type && r.type !== f.type) return false;
        if(f.finish && (r.finish.charAt(0).toUpperCase()+r.finish.slice(1)) !== f.finish) return false;
        if(f.rarity && (r.rarity.charAt(0).toUpperCase()+r.rarity.slice(1)) !== f.rarity) return false;
        if(f.variant && r.variant !== f.variant) return false;
        if(q){
          const hay = (r.name+" "+r.type+" "+r.variant+" "+r.number).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      const { key, dir } = state.sort;
      const mul = dir === 'asc' ? 1 : -1;
      v.sort((a,b)=>{
        const A = a[key] ?? "", B = b[key] ?? "";
        if(key === 'price'){ return ((a.price||0) - (b.price||0)) * mul; }
        if(key === 'stock'){ return ((a.stock||0) - (b.stock||0)) * mul; }
        if(key === 'number'){
          const an = parseInt(String(A).replace(/\D+/g,''),10)||0;
          const bn = parseInt(String(B).replace(/\D+/g,''),10)||0;
          if(an!==bn) return (an-bn)*mul;
          return String(A).localeCompare(String(B)) * mul;
        }
        return String(A).localeCompare(String(B)) * mul;
      });

      state.view = v;
    }

    function resetToFirstPageAndRender(){
      state.page = 1;
      applyFiltersAndSort();
      renderTable();
    }

    function attachEvents(){
      document.getElementById('q').addEventListener('input', e => { state.filters.q = e.target.value; resetToFirstPageAndRender(); });
      document.getElementById('typeFilter').addEventListener('change', e => { state.filters.type = e.target.value; resetToFirstPageAndRender(); });
      document.getElementById('finishFilter').addEventListener('change', e => { state.filters.finish = e.target.value; resetToFirstPageAndRender(); });
      document.getElementById('rarityFilter').addEventListener('change', e => { state.filters.rarity = e.target.value; resetToFirstPageAndRender(); });
      document.getElementById('variantFilter').addEventListener('change', e => { state.filters.variant = e.target.value; resetToFirstPageAndRender(); });
      document.getElementById('inStock').addEventListener('change', e => { state.filters.inStock = e.target.checked; resetToFirstPageAndRender(); });
      document.getElementById('clearFilters').addEventListener('click', ()=>{
        state.filters = { q:'', type:'', finish:'', rarity:'', variant:'', inStock:false };
        document.getElementById('q').value = '';
        document.getElementById('qsHeader').value = '';
        document.getElementById('typeFilter').value = '';
        document.getElementById('finishFilter').value = '';
        document.getElementById('rarityFilter').value = '';
        document.getElementById('variantFilter').value = '';
        document.getElementById('inStock').checked = false;
        resetToFirstPageAndRender();
      });

      // header sorters
      document.querySelectorAll('th[data-key]').forEach(th=>{
        th.addEventListener('click', ()=>{
          const k = th.getAttribute('data-key');
          if(state.sort.key === k){
            state.sort.dir = (state.sort.dir === 'asc') ? 'desc' : 'asc';
          }else{
            state.sort.key = k; state.sort.dir = 'asc';
          }
          resetToFirstPageAndRender();
        });
      });

      // pager buttons
      document.getElementById('prevBtn').addEventListener('click', ()=>{
        if(state.page > 1){ state.page--; renderTable(); }
      });
      document.getElementById('nextBtn').addEventListener('click', ()=>{
        const totalPages = Math.max(1, Math.ceil(state.view.length / state.pageSize));
        if(state.page < totalPages){ state.page++; renderTable(); }
      });

      // page size
      const ps = document.getElementById('pageSize');
      ps.addEventListener('change', ()=>{
        state.pageSize = parseInt(ps.value, 10) || 20;
        state.page = 1;
        renderTable();
      });
    }

    /* -----------------------------
       CART (placeholder)
       ----------------------------- */
    function addToCart(info){
      // Stand-in; replace with your real cart logic later
      alert(`Added to cart:\n${info.n} #${info.no}\n${info.f} â€¢ ${info.v}`);
    }

    /* -----------------------------
       DATA LOADING
       ----------------------------- */
    async function fetchCards(setCode){
      const url = `${CARDS_API_BASE}?cards=1&set=${encodeURIComponent(setCode)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const rows = Array.isArray(json) ? json : (json.rows || json.data || []);
      return rows.map(normalizeRow);
    }

    async function init(){
      attachEvents();

      const params = new URLSearchParams(location.search);
      state.setCode = (params.get('code') || '').trim().toLowerCase();
      state.setName = params.get('name') || state.setCode || 'Set';
      document.getElementById('setTitle').textContent = state.setName || 'Set';

      if(!state.setCode){
        document.getElementById('tbody').innerHTML = `<tr><td colspan="10" class="no-results">Missing ?code=SETCODE</td></tr>`;
        updatePager();
        return;
      }

      try{
        state.raw = await fetchCards(state.setCode);
        renderFiltersFromData(state.raw);
        state.page = 1;
        applyFiltersAndSort();
        renderTable();
      }catch(err){
        console.error(err);
        document.getElementById('tbody').innerHTML = `<tr><td colspan="10" class="no-results">Failed to load cards for ${state.setCode}.</td></tr>`;
        updatePager();
      }
    }

    init();
  </script>
</body>
</html>
