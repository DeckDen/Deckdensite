<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Card â€“ DeckDen</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --bg:#ffffff; --text:#222; --muted:#666;
      --accent:#b84e00; --accent-press:#944000;
      --card:#fff; --line:#e8e8e8; --chip:#f5f5f5;
    }
    .dark-mode{
      --bg:#121212; --text:#f1f1f1; --muted:#c7c7c7;
      --accent:#b84e00; --accent-press:#944000;
      --card:#1b1b1b; --line:#2a2a2a; --chip:#1f1f1f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif;transition:background .25s,color .25s}
    a{color:inherit;text-decoration:none}

    /* Header */
    nav{width:100%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:8px 16px;position:sticky;top:0;z-index:10}
    .nav-left{display:flex;align-items:center;gap:10px}
    .nav-left img{width:34px;height:34px;object-fit:contain;cursor:pointer}
    .nav-links{display:flex;gap:12px}
    .nav-links a{color:#fff;font-weight:600;opacity:.95}
    .nav-links a:hover{opacity:1}
    .nav-right{display:flex;align-items:center;gap:10px}
    .nav-right .icon-btn{background:#fff;border:none;color:var(--accent);padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600}

    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:20px}
    @media (max-width: 940px){ .grid{grid-template-columns:1fr} }

    .cardbox{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .h1{font-size:1.6rem;margin:0 0 8px}
    .sub{color:var(--muted);font-size:.95rem}

    .imgwrap{display:flex;flex-direction:column;gap:10px;align-items:center}
    .imgwrap img{width:100%;max-width:360px;border-radius:12px;border:1px solid var(--line);background:#000}
    .btn{background:var(--chip);border:1px solid var(--line);padding:8px 10px;border-radius:10px;cursor:pointer;white-space:nowrap}
    .btn:hover{border-color:var(--muted)}
    .btn.accent{background:var(--accent);border-color:transparent;color:#fff}
    .btn.accent:hover{background:var(--accent-press)}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    .meta{display:grid;grid-template-columns:1fr;gap:12px}
    .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .box h3{margin:.2rem 0 .6rem;font-size:1.05rem}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px}
    .kv div.label{color:var(--muted)}
    .ruletext{white-space:pre-line}

    .variants li{margin:6px 0}
    .muted{color:var(--muted)}

    .err{padding:16px;background:#fff3f3;border:1px solid #ffd0d0;color:#b30000;border-radius:10px}
    .info{padding:12px;background:var(--chip);border:1px dashed var(--line);border-radius:10px;color:var(--muted)}
  </style>
</head>
<body>
  <nav>
    <div class="nav-left">
      <a href="index.html" title="Home"><img src="Deckden Transparent.png" alt="DeckDen logo"></a>
      <div class="nav-links">
        <a href="magic-sets.html">Magic Sets</a>
        <a href="set.html">Set</a>
      </div>
    </div>
    <div class="nav-right">
      <button class="icon-btn" onclick="toggleDarkMode()" title="Dark mode">ðŸŒ™</button>
    </div>
  </nav>

  <div class="container">
    <div id="error" class="err" style="display:none"></div>

    <div class="grid">
      <!-- Left: Image + controls -->
      <div class="cardbox">
        <div class="imgwrap">
          <img id="cardImg" alt="Card image" src="" style="display:none"/>
          <div class="row">
            <button id="flipBtn" class="btn" style="display:none"><i class="fa-solid fa-retweet"></i> Flip</button>
            <a id="scryfallLink" class="btn" target="_blank" rel="noopener">Open on Scryfall</a>
          </div>
        </div>
      </div>

      <!-- Right: Details -->
      <div class="meta">
        <div class="box">
          <h1 id="title" class="h1">Loadingâ€¦</h1>
          <div class="sub" id="subtitle"></div>
          <div class="kv" style="margin-top:10px">
            <div class="label">Price (AUD)</div><div id="price">â€”</div>
            <div class="label">Stock</div><div id="stock">â€”</div>
            <div class="label">Variant</div><div id="variant">â€”</div>
            <div class="label">Finish</div><div id="finish">â€”</div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn accent" id="addBtn"><i class="fa-solid fa-cart-plus"></i> Add to cart</button>
          </div>
        </div>

        <div class="box">
          <h3>Rules Text</h3>
          <div id="rules" class="ruletext muted">â€”</div>
        </div>

        <div class="box">
          <h3>Other variants in stock</h3>
          <ul id="variantsList" class="variants"></ul>
          <div id="noVariants" class="muted">None in stock.</div>
        </div>
      </div>
    </div>

    <div id="tips" class="info" style="display:none;margin-top:16px"></div>
  </div>

  <script>
    // -------- Config
    const CARDS_API_BASE = "https://script.google.com/macros/s/AKfycbyakGYRw-vHJKd4RkkoBwVCyjxVHSMomxHWcXDl-mahuKFoPrpt6YJS0xBl1Cn47hGm/exec";

    // -------- Theme
    function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); }

    // -------- Helpers
    function qs(name){ return new URLSearchParams(location.search).get(name); }
    function normalizeNum(s){
      // Collector numbers can be like "317a", "382", "527â˜…"; normalize for compare
      return String(s||"").trim().toLowerCase().replace(/\s+/g,'');
    }
    function cap(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

    function showError(msg, tips){
      const e = document.getElementById('error');
      e.style.display = 'block';
      e.textContent = msg;
      if(tips){
        const t = document.getElementById('tips');
        t.style.display = 'block';
        t.innerHTML = tips;
      }
    }

    function pickBestMatch(rows, params){
      const wantNum = normalizeNum(params.number);
      const wantName = (params.name||"").trim().toLowerCase();
      const wantFinish = (params.finish||"").trim().toLowerCase();   // "foil", "non-foil", "etched"
      const wantVariant = (params.variant||"").trim();               // "Borderless", etc. (case-sensitive in sheet)

      let candidates = rows;

      // Narrow by number OR name (prefer number if provided)
      if(wantNum){
        candidates = candidates.filter(r => normalizeNum(r.number) === wantNum);
      }else if(wantName){
        candidates = candidates.filter(r => String(r.name||"").toLowerCase() === wantName);
      }else{
        return null; // nothing to match on
      }

      // Optional disambiguation
      if(wantVariant) candidates = candidates.filter(r => r.variant === wantVariant);
      if(wantFinish)  candidates = candidates.filter(r => r.finish === wantFinish);

      if(candidates.length === 0) return null;

      // Prefer one with stock > 0; otherwise first
      const withStock = candidates.find(r => (r.stock || 0) > 0);
      return withStock || candidates[0];
    }

    async function fetchSetRows(code){
      const url = `${CARDS_API_BASE}?cards=1&set=${encodeURIComponent(code)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const rows = Array.isArray(json) ? json : (json.rows || json.data || []);

      // Normalize to the fields we need
      return rows.map(r=>{
        return {
          name: r["Card Name"] || r.name || "",
          setName: r["Set Name"] || r.set_name || "",
          code: (r["Set Code"] || r.set || "").toString().toLowerCase(),
          number: r["Collector No"] || r["Collector Number"] || r.number || "",
          type: r["Type Line"] || r.type || "",
          variant: r["Variant"] || r.variant || "Standard",
          finish: (r["Finish"] || r.finish || "").toString().toLowerCase(), // foil/non-foil/etched
          price: parseFloat(r["Sell Price (AUD, +10%)"] || r.price || "0") || 0,
          stock: parseInt(r["Qty Owned"] || r.stock || "0",10) || 0
        };
      });
    }

    async function fetchScryfall(setCode, collectorNo, cardName){
      // Try direct endpoint first
      async function tryDirect(){
        const url = `https://api.scryfall.com/cards/${encodeURIComponent(setCode)}/${encodeURIComponent(collectorNo)}`;
        const res = await fetch(url);
        if(res.ok) return res.json();
        throw new Error(`Scryfall ${res.status}`);
      }
      // Fallback: search by set+name (less precise, but helpful)
      async function trySearch(){
        const q = `!"${cardName}" set:${setCode}`;
        const url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(q)}&unique=prints`;
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Scryfall search ${res.status}`);
        const data = await res.json();
        return (data.data && data.data.length) ? data.data[0] : null;
      }

      try{
        return await tryDirect();
      }catch(_){
        if(cardName){
          try{ return await trySearch(); }catch(e2){ return null; }
        }
        return null;
      }
    }

    function extractImagesAndRules(cardJson){
      if(!cardJson) return { faces: [], scryUrl: "" };

      const faces = [];
      if(Array.isArray(cardJson.card_faces) && cardJson.card_faces.length){
        for(const f of cardJson.card_faces){
          faces.push({
            img: f.image_uris ? (f.image_uris.normal || f.image_uris.large || f.image_uris.small) : "",
            rules: f.oracle_text || ""
          });
        }
      }else{
        faces.push({
          img: cardJson.image_uris ? (cardJson.image_uris.normal || cardJson.image_uris.large || cardJson.image_uris.small) : "",
          rules: cardJson.oracle_text || ""
        });
      }
      const scryUrl = cardJson.scryfall_uri || cardJson.uri || "";
      return { faces, scryUrl };
    }

    function renderPage(active, allRowsForName, scry){
      // Title + subtitle
      document.getElementById('title').textContent = active.name || "Card";
      document.getElementById('subtitle').textContent =
        `${(active.setName||"").trim()} â€¢ #${active.number} â€¢ ${active.variant} â€¢ ${cap(active.finish)}`;

      // Price/stock
      document.getElementById('price').textContent = active.price > 0 ? `$${Number(active.price).toFixed(0)}` : "â€”";
      document.getElementById('stock').textContent = active.stock;
      document.getElementById('variant').textContent = active.variant || "Standard";
      document.getElementById('finish').textContent = cap(active.finish) || "â€”";

      // Scryfall link
      const sLink = document.getElementById('scryfallLink');
      sLink.href = scry.scryUrl || `https://scryfall.com/search?q=${encodeURIComponent('!"'+active.name+'" set:'+active.code)}`;

      // Image + rules + flip
      const imgEl = document.getElementById('cardImg');
      const rulesEl = document.getElementById('rules');
      const flipBtn = document.getElementById('flipBtn');

      if(scry.faces.length){
        let idx = 0;
        function paint(){
          const f = scry.faces[idx];
          if(f.img){ imgEl.src = f.img; imgEl.style.display = 'block'; }
          else { imgEl.style.display = 'none'; }
          rulesEl.textContent = f.rules || "â€”";
        }
        paint();

        if(scry.faces.length > 1){
          flipBtn.style.display = 'inline-flex';
          flipBtn.onclick = ()=>{ idx = (idx+1) % scry.faces.length; paint(); };
        }else{
          flipBtn.style.display = 'none';
        }
      }else{
        imgEl.style.display = 'none';
        rulesEl.textContent = "â€”";
        flipBtn.style.display = 'none';
      }

      // Other variants (in stock) for same name
      const ul = document.getElementById('variantsList');
      const none = document.getElementById('noVariants');
      const others = allRowsForName
        .filter(r => (r.finish !== active.finish || r.variant !== active.variant || r.number !== active.number))
        .filter(r => r.stock > 0);

      if(!others.length){
        ul.innerHTML = "";
        none.style.display = 'block';
      }else{
        none.style.display = 'none';
        ul.innerHTML = others.map(r => {
          const url = `card.html?code=${encodeURIComponent(r.code)}&number=${encodeURIComponent(r.number)}&name=${encodeURIComponent(r.name)}&variant=${encodeURIComponent(r.variant)}&finish=${encodeURIComponent(r.finish)}`;
          return `<li><a href="${url}">${r.name}</a> â€” #${r.number} â€¢ ${r.variant} â€¢ ${cap(r.finish)} â€¢ $${Number(r.price).toFixed(0)} (${r.stock} in stock)</li>`;
        }).join('');
      }

      // Add-to-cart placeholder
      document.getElementById('addBtn').onclick = ()=>{
        alert(`Added to cart:\n${active.name} #${active.number}\n${active.variant} â€¢ ${cap(active.finish)} â€¢ $${Number(active.price).toFixed(0)}`);
      };
    }

    async function init(){
      // Params
      const code = (qs('code')||'').trim().toLowerCase();
      const number = qs('number'); // may be null
      const name = qs('name');     // may be null
      const variant = qs('variant');
      const finish = qs('finish');

      if(!code){
        showError("Missing set code (?code=).", `Example: <code>card.html?code=fin&number=317</code>`);
        return;
      }
      if(!number && !name){
        showError("Missing identifier. Provide either ?number= or ?name=.", `Examples:<br>
          <code>card.html?code=${code}&number=317</code><br>
          <code>card.html?code=${code}&name=Sephiroth, Fabled Soldier</code>`);
        return;
      }

      try{
        // Load all rows for the set
        const rows = await fetchSetRows(code);
        // Find active row
        const active = pickBestMatch(rows, { number, name, variant, finish });
        if(!active){
          showError("Failed to load this card. Check the URL parameters (code, number/name).",
            `Tip: Open <a target="_blank" rel="noopener" href="set.html?code=${encodeURIComponent(code)}">the set list</a> and click the card again.`
          );
          return;
        }

        // Fetch Scryfall art/rules
        const scryJson = await fetchScryfall(code, active.number, active.name);
        const scry = extractImagesAndRules(scryJson);

        // Render
        const rowsSameName = rows.filter(r => String(r.name||"").toLowerCase() === String(active.name||"").toLowerCase());
        renderPage(active, rowsSameName, scry);

      }catch(err){
        console.error(err);
        showError("Unexpected error loading this card.",
          `Please try reloading. If it persists, verify your Apps Script web app URL in <code>CARDS_API_BASE</code>.`);
      }
    }

    init();
  </script>
</body>
</html>
